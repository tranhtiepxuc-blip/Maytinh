import SwiftUI

struct ContentView: View {

    @State private var display = "0"
    @State private var storedValue: Double? = nil
    @State private var pendingOp: Op? = nil
    @State private var isTyping = false

    enum Op { case add, sub, mul, div }

    var body: some View {
        VStack(spacing: 12) {
            Spacer()

            Text(display)
                .font(.system(size: 64, weight: .semibold, design: .rounded))
                .frame(maxWidth: .infinity, alignment: .trailing)
                .lineLimit(1)
                .minimumScaleFactor(0.3)
                .padding(.horizontal, 20)

            VStack(spacing: 10) {
                row(["AC", "√∑", "√ó", "‚àí"])
                row(["7", "8", "9", "+"])
                row(["4", "5", "6", "="], specialEquals: true)
                row(["1", "2", "3", "."])
                HStack(spacing: 10) {
                    button("0", wide: true)
                    button("‚å´")
                }
            }
            .padding(.horizontal, 16)
            .padding(.bottom, 24)
        }
        .background(Color(.systemBackground))
    }

    // MARK: - UI Helpers

    @ViewBuilder
    private func row(_ titles: [String], specialEquals: Bool = false) -> some View {
        HStack(spacing: 10) {
            ForEach(titles, id: \.self) { t in
                if specialEquals && t == "=" {
                    button(t, isEquals: true)
                } else {
                    button(t)
                }
            }
        }
    }

    private func button(_ title: String, wide: Bool = false, isEquals: Bool = false) -> some View {
        let bg: Color = {
            if isEquals { return Color.green.opacity(0.22) }
            if ["+", "‚àí", "√ó", "√∑"].contains(title) { return Color.orange.opacity(0.22) }
            if ["AC", "‚å´"].contains(title) { return Color.gray.opacity(0.22) }
            return Color.blue.opacity(0.18)
        }()

        return Button {
            tap(title)
        } label: {
            Text(title)
                .font(.system(size: 24, weight: .semibold, design: .rounded))
                .frame(maxWidth: wide ? .infinity : nil)
                .frame(height: 56)
                .frame(minWidth: wide ? 0 : 56)
                .background(bg)
                .clipShape(RoundedRectangle(cornerRadius: 14))
        }
    }

    // MARK: - Logic

    private func tap(_ t: String) {
        switch t {

        case "AC":
            display = "0"
            storedValue = nil
            pendingOp = nil
            isTyping = false

        case "‚å´":
            if isTyping {
                display.removeLast()
                if display.isEmpty {
                    display = "0"
                    isTyping = false
                }
            } else {
                display = "0"
            }

        case ".":
            if !isTyping {
                display = "0."
                isTyping = true
            } else if !display.contains(".") {
                display += "."
            }

        case "+", "‚àí", "√ó", "√∑":
            commitPendingIfNeeded()
            storedValue = parse(display)
            pendingOp = op(from: t)
            isTyping = false

        case "=":
            guard let op = pendingOp,
                  let a = storedValue else { return }
            let b = parse(display)
            let result = apply(op: op, a: a, b: b)
            display = format(result)
            storedValue = nil
            pendingOp = nil
            isTyping = false

        default: // numbers
            if isTyping {
                if display == "0" {
                    display = t
                } else {
                    display += t
                }
            } else {
                display = t
                isTyping = true
            }
        }
    }

    private func op(from s: String) -> Op {
        switch s {
        case "+": return .add
        case "‚àí": return .sub
        case "√ó": return .mul
        default:  return .div
        }
    }

    private func commitPendingIfNeeded() {
        if let op = pendingOp,
           let a = storedValue,
           isTyping {
            let b = parse(display)
            let result = apply(op: op, a: a, b: b)
            display = format(result)
            storedValue = result
            isTyping = false
        }
    }

    private func apply(op: Op, a: Double, b: Double) -> Double {
        switch op {
        case .add: return a + b
        case .sub: return a - b
        case .mul: return a * b
        case .div: return b == 0 ? 0 : a / b
        }
    }

    // MARK: - Number Format (VN)

    private func format(_ x: Double) -> String {
        if x.isInfinite || x.isNaN { return "0" }

        let formatter = NumberFormatter()
        formatter.numberStyle = .decimal
        formatter.locale = Locale(identifier: "vi_VN") // üáªüá≥
        formatter.maximumFractionDigits = 8
        formatter.minimumFractionDigits = 0

        return formatter.string(from: NSNumber(value: x)) ?? "0"
    }

    private func parse(_ text: String) -> Double {
        // Chuy·ªÉn t·ª´ d·∫°ng hi·ªÉn th·ªã VN v·ªÅ Double
        let normalized = text
            .replacingOccurrences(of: ".", with: "")
            .replacingOccurrences(of: ",", with: ".")
        return Double(normalized) ?? 0
    }
}
