name: Build IPA (Unsigned)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Unzip project
        run: |
          ls -la
          mkdir -p project
          unzip -o "*.zip" -d project
          echo "==== Find xcodeproj ===="
          find project -maxdepth 4 -name "*.xcodeproj" -print
          echo "==== Find ContentView.swift ===="
          find project -maxdepth 6 -name "ContentView.swift" -print

      - name: Build (no code signing)
        run: |
          cd project
          # nhảy vào đúng thư mục chứa .xcodeproj
          PROJ_DIR="$(find . -maxdepth 4 -type d -name '*.xcodeproj' | head -n 1 | sed 's/\/[^\/]*$//')"
          echo "PROJ_DIR=$PROJ_DIR"
          cd "$PROJ_DIR"

          xcodebuild -version
          xcodebuild \
            -project "SimpleCalculator.xcodeproj" \
            -scheme "SimpleCalculator" \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath build \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: Package IPA
        run: |
          cd project
          APP_PATH="$(find . -path '*Release-iphoneos/*.app' | head -n 1)"
          echo "APP_PATH=$APP_PATH"
          rm -rf Payload
          mkdir -p Payload
          cp -R "$APP_PATH" Payload/
          zip -r SimpleCalculator.ipa Payload
          ls -la SimpleCalculator.ipa

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: SimpleCalculator-IPA
          path: project/SimpleCalculator.ipa
